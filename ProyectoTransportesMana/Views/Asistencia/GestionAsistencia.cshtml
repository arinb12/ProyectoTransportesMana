@using ProyectoTransportesMana.Models
@using ProyectoTransportesMana.Contracts.Busetas

@{
    ViewData["Title"] = "Control de Asistencia – Transportes Maná";
    Layout = "~/Views/Shared/_LayoutInterno.cshtml";

    var instituciones = ViewBag.Instituciones as List<InstitucionModel> ?? new();
    var busetas = ViewBag.Busetas as List<BusetaListItemResponse> ?? new();
}

@section Styles {
    <link rel="stylesheet" href="~/css/asistencia/gestion-asistencia.css" />
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="text-dark">Gestión de Asistencia Diaria</h1>
</div>

@if (!instituciones.Any())
{
    <div class="alert alert-warning">
        No hay instituciones registradas. Registre al menos una institución para gestionar la asistencia.
    </div>
}
else
{
    foreach (var inst in instituciones)
    {
        var escuelaId = inst.IdInstitucion;
        var nombreEscuela = inst.Nombre;

        <div class="asistencia-bloque mb-5" data-escuela-id="@escuelaId">
            <h4 class="asistencia-escuela-nombre mb-3">
                @nombreEscuela
            </h4>

            <div class="asistencia-header-filters d-flex flex-wrap gap-3 align-items-end mb-3">
                <!-- Siempre se tomará la asistencia del día actual -->
                <div>
                    <label for="buseta-@escuelaId" class="asistencia-label">Buseta</label>
                    <select id="buseta-@escuelaId" class="asistencia-select">
                        <option value="">— Seleccione —</option>
                        @foreach (var b in busetas)
                        {
                            <option value="@b.Id">
                                @b.Placa - @b.NombreConductor
                            </option>
                        }
                    </select>
                </div>

                <div>
                    <label for="tipoViaje-@escuelaId" class="asistencia-label">Tipo de viaje</label>
                    <select id="tipoViaje-@escuelaId" class="asistencia-select">
                        <option value="">— Seleccione —</option>
                        <option value="ida-manana">Ida Mañana</option>
                        <option value="ida-tarde">Ida Tarde</option>
                        <option value="vuelta-manana">Vuelta Mañana</option>
                        <option value="vuelta-tarde">Vuelta Tarde</option>
                    </select>
                </div>


                <div>
                    <button class="asistencia-boton-filtros"
                            onclick="aplicarFiltros(@escuelaId)">
                        Aplicar Filtros
                    </button>
                </div>
            </div>

            <div class="asistencia-alerta-filtros" id="alerta-filtros-@escuelaId">
                <p class="text-muted">
                    ⚠️ Para ver la lista de estudiantes, seleccione una buseta y aplique los filtros.
                </p>
            </div>

            <!-- Tabla: oculta por defecto. Luego se llenará vía AJAX/DataTables -->
            <div class="asistencia-table-container d-none" id="tabla-container-@escuelaId">
                <table id="tablaAsistencia-@escuelaId" class="asistencia-table tabla-asistencia-dinamica">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Apellidos</th>
                            <th>Sección</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        @* se llenará luego vía AJAX/DataTables *@
                    </tbody>
                </table>

                <div class="mt-3 d-flex justify-content-end gap-3 flex-wrap">
                    <button class="asistencia-boton-filtros"
                            onclick="guardarAsistencia(@escuelaId)">
                        Guardar Asistencia
                    </button>
                </div>
            </div>
        </div>
    }
}

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            document.body.addEventListener("change", (event) => {
                const select = event.target;
                if (!select.classList.contains("asistencia-estado-select")) return;

                const tr = select.closest("tr");
                if (!tr) return;

                tr.classList.remove("asistencia-row-updated");
                void tr.offsetWidth;
                tr.classList.add("asistencia-row-updated");
            });
        });
    </script>

    <script src="~/js/asistencia/gestion-asistencia.js" asp-append-version="true"></script>
}
