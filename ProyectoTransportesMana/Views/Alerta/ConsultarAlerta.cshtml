@{
    ViewData["Title"] = "Consultar Alertas";
    Layout = "_LayoutInterno";
    int? rolActual = Context.Session.GetInt32("IdRol");
}


@section Styles {
    <link rel="stylesheet" href="~/css/instituciones/instituciones.css" />
}

<div class="container-fluid p-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="text-dark">Alertas Informativas</h1>
        @* Solo mostrar el botón si el rol es Admin (1) o Asistente (5) *@
        @if (rolActual == 1 || rolActual == 5)
        {
            <button class="btn pastel-btn" data-bs-toggle="modal" data-bs-target="#modalAlerta">
                <i class="bi bi-bell-fill me-1"></i> Generar Alerta
            </button>
        }
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-info text-dark fw-bold">
            <i class="bi bi-megaphone me-2"></i>Listado de Alertas
        </div>
        <div class="card-body">
            <table id="tablaAlertas" class="table table-hover table-bordered pastel-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Título</th>
                        <th>Mensaje</th>
                        <th>Fecha de Publicación</th>
                        <th>Visibilidad</th>
                        <th>Leído</th>
                        <th>Tipo</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>


    <div class="modal fade" id="modalAlerta" tabindex="-1" aria-labelledby="modalAlertaLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-info">
                    <h5 class="modal-title text-dark" id="modalAlertaLabel">
                        <i class="bi bi-bell me-2"></i>Registrar
                        Nueva Alerta
                    </h5> <button type="button" class="btn-close" data-bs-dismiss="modal"
                                  aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <form id="formAlerta">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="tipoAlerta" class="form-label">Tipo de Alerta</label>
                                <select id="tipoAlerta" class="form-select" required>
                                    <option selected disabled>Seleccione un tipo</option>
                                    <option>Retraso</option>
                                    <option>Cambio Ruta</option>
                                    <option>Evento Especial</option>
                                    <option>Otro</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="fechaPublicacion" class="form-label">
                                    Fecha de
                                    Publicación
                                </label> <input type="date" id="fechaPublicacion" class="form-control"
                                                required />
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="tituloAlerta" class="form-label">
                                Título <span class="text-danger">*</span>
                            </label> <input type="text" id="tituloAlerta"
                                            class="form-control" required />
                        </div>
                        <div class="mb-3">
                            <label for="contenidoAlerta" class="form-label">Mensaje / Contenido</label>
                            <textarea class="form-control" id="contenidoAlerta" rows="5"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="publico" class="form-label">Público Destinatario</label> <select id="publico" class="form-select">
                                <option value="todos">Todos (Masiva)</option>
                                <option value="buseta">Por Buseta</option>
                                <option value="encargado">Por Encargado Legal</option>
                            </select>
                        </div>
                        <div class="mb-3 d-none" id="grupoBuseta">
                            <label for="buseta" class="form-label">
                                Selecciona una
                                Buseta
                            </label> <select id="buseta" class="form-select">
                                <option disabled selected value="">Selecciona una buseta</option>
                            </select>
                        </div>
                        <div class="mb-3 d-none" id="grupoEncargado">
                            <label for="encargado"
                                   class="form-label">Selecciona un Encargado Legal</label> <select id="encargado"
                                                                                                    class="form-select">
                                <option disabled selected value="">Selecciona un encargado</option>
                            </select>
                        </div>
                        <div class="text-end">
                            <button type="submit" class="btn pastel-btn">Guardar Alerta</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        window.CURRENT_USER_ID = @(ViewData["CurrentUserId"]);
        console.log('CURRENT_USER_ID=', window.CURRENT_USER_ID);

        const encargadosMap = new Map();
        const busetasMap = new Map();

        function togglePublicoGroups() {
            const publico = document.getElementById('publico')?.value;
            document.getElementById('grupoBuseta').classList.toggle('d-none', publico !== 'buseta');
            document.getElementById('grupoEncargado').classList.toggle('d-none', publico !== 'encargado');
        }

        async function marcarAlertasComoLeidas() {
            if (!window.CURRENT_USER_ID || window.CURRENT_USER_ID === 0) return;
            await fetch(`${window.API_BASE}/api/alerta/user/${window.CURRENT_USER_ID}/marcar-leidas`, { method: 'POST' });
        }

        async function cargarLookups() {
            const busRes = await fetch(`${window.API_BASE}/api/alerta/busetas`);
            const encRes = await fetch(`${window.API_BASE}/api/alerta/encargados`);

            if (busRes.ok) {
                const data = await busRes.json();
                const sel = document.getElementById('buseta');
                data.forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = b.Id;
                    opt.textContent = b.Texto;
                    sel.appendChild(opt);
                    busetasMap.set(String(b.Id), b.Texto);
                });
            }

            if (encRes.ok) {
                const data = await encRes.json();
                const sel = document.getElementById('encargado');
                data.forEach(e => {
                    const opt = document.createElement('option');
                    opt.value = e.IdUsuario;
                    opt.textContent = e.NombreCompleto;
                    sel.appendChild(opt);
                    encargadosMap.set(opt.value, opt.textContent);
                });
            }
        }

        document.getElementById('formAlerta').addEventListener('submit', async function (e) {
            e.preventDefault();

            const publicoValue = publico.value;

            if (publicoValue === "buseta" && !buseta.value) { alert("Debe seleccionar una buseta."); return; }
            if (publicoValue === "encargado" && !encargado.value) { alert("Debe seleccionar un encargado."); return; }

            let publicoFinal = publicoValue;
            if (publicoValue === "buseta") publicoFinal = `buseta:${buseta.value}`;
            if (publicoValue === "encargado") publicoFinal = `usuario:${encargado.value}`;

            const payload = {
                EnviadoPor: Number(window.CURRENT_USER_ID),
                Titulo: tituloAlerta.value,
                TipoAlerta: tipoAlerta.value,
                Mensaje: contenidoAlerta.value,
                PublicoDestino: publicoFinal,
                FechaPublicacion: fechaPublicacion.value
            };

            const resp = await fetch(`${window.API_BASE}/api/alerta`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (resp.ok) {
                bootstrap.Modal.getInstance(document.getElementById('modalAlerta')).hide();
                await cargarAlertas();
                await actualizarContadorAlertas();
            }
        });

        document.addEventListener('DOMContentLoaded', async () => {
            await cargarLookups();
            await cargarAlertas();
            await marcarAlertasComoLeidas();
            togglePublicoGroups();
        });

           async function cargarAlertas() {
    const rolActual = Number(window.ROL_ACTUAL);
    const userId = Number(window.CURRENT_USER_ID);

    let url = `${window.API_BASE}/api/alerta/listar`; // URL general para obtener alertas
    const resp = await fetch(url);
    if (!resp.ok) {
        console.error('Error cargando alertas', resp.status);
        return;
    }

    const allAlertas = await resp.json();
    const tbody = document.querySelector('#tablaAlertas tbody');
    tbody.innerHTML = '';

    // Filtrar alertas según rol
    let alertasFiltradas = [];

    if (rolActual === 1 || rolActual === 5) {
        // Admin o Asistente: todas las alertas
        alertasFiltradas = allAlertas;
    } else if (rolActual === 2) {
        // Encargado Legal: solo las alertas masivas o dirigidas a este usuario
        alertasFiltradas = allAlertas.filter(a => {
            const destino = a.publico_destino ?? a.PublicoDestino ?? '';
            return destino === 'todos' || destino === `usuario:${userId}`;
        });
    } else {
        // Otros roles: solo alertas masivas
        alertasFiltradas = allAlertas.filter(a => {
            const destino = a.publico_destino ?? a.PublicoDestino ?? '';
            return destino === 'todos';
        });
    }

    alertasFiltradas.forEach(r => {
        let publicoTexto = r.publico_destino ?? r.PublicoDestino ?? '';

        for (let [key, value] of busetasMap.entries()) {
            if (publicoTexto === `buseta:${key}`) {
                publicoTexto = "Buseta: " + value;
                break;
            }
        }

        if (String(publicoTexto).startsWith("usuario:")) {
            const id = String(publicoTexto).split(":")[1];
            publicoTexto = "Encargado: " + (encargadosMap.get(id) || "Desconocido");
        }

        if (publicoTexto === "todos") publicoTexto = "Todos";

        const leidoRaw = r.Leido ?? r.leido;
        const leidoFlag =
            leidoRaw === true ||
            leidoRaw === 1 ||
            leidoRaw === '1' ||
            (typeof leidoRaw === 'string' && leidoRaw.toLowerCase() === 'sí') ||
            (typeof leidoRaw === 'string' && leidoRaw.toLowerCase() === 'si');

        const fecha = r.fecha_publicacion || r.Fecha_Publicacion || r.FechaPublicacion;

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${r.id_alerta ?? r.Id_Alerta ?? r.IdAlerta ?? ''}</td>
            <td>${r.titulo ?? r.Titulo ?? ''}</td>
            <td>${r.mensaje ?? r.Mensaje ?? ''}</td>
            <td>${fecha ? new Date(fecha).toLocaleString() : ''}</td>
            <td>${publicoTexto}</td>
            <td class="${leidoFlag ? 'text-success fw-bold' : 'text-danger'}">${leidoFlag ? 'Sí' : 'No'}</td>
            <td>${r.tipo_alerta ?? r.TipoAlerta ?? ''}</td>
            <td><a href="#" onclick="borrarAlerta(${r.id_alerta ?? r.IdAlerta ?? 0})"><i class="fas fa-trash"></i></a></td>
        `;
        tbody.appendChild(tr);
    });
}

        async function borrarAlerta(id) {
            await fetch(`${window.API_BASE}/api/alerta/${id}`, { method: 'DELETE' });
            cargarAlertas();
        }

        document.getElementById('publico').addEventListener('change', togglePublicoGroups);

        document.getElementById('modalAlerta').addEventListener('shown.bs.modal', function () {
            document.getElementById('publico').value = 'todos';
            document.getElementById('buseta').value = '';
            document.getElementById('encargado').value = '';
            togglePublicoGroups();
        });
    </script>
}