@{
    ViewData["Title"] = "Gestión Maestras";
    Layout = "~/Views/Shared/_LayoutInterno.cshtml";
}

@section Styles {
    <link rel="stylesheet" href="~/css/estudiantes/gestion-estudiantes.css" />
    <style>
        .pastel-table thead th {
            background: #e8f4ff;
        }

        .badge-activo {
            background-color: #28a745;
        }

        .badge-inactivo {
            background-color: #dc3545;
        }

        #modalMaestra .modal-header {
            background: #e8f4ff !important;
        }
    </style>
}

<div class="container-fluid p-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="text-dark">Gestión de Maestras</h1>
        <button class="btn pastel-btn" data-bs-toggle="modal" data-bs-target="#modalMaestra" onclick="nuevaMaestra()">
            <i class="fas fa-plus me-1"></i> Agregar
        </button>
    </div>

    <div class="card mb-4 shadow">
        <div class="card-header bg-info d-flex align-items-center">
            <i class="fas fa-table me-2 text-dark"></i>
            <span class="text-dark fw-bold">Listado Maestras</span>
        </div>
        <div class="card-body">
            <table id="tablaMaestras" class="table table-hover table-bordered pastel-table align-middle">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Institución</th>
                        <th>Sección</th>
                        <th class="text-center">Estado</th>
                        <th class="text-center" style="width: 110px;">Acciones</th>
                    </tr>
                </thead>
                <tbody id="tbodyMaestras"></tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="modalMaestra" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content rounded-4">
            <div class="modal-header">
                <h5 class="modal-title text-dark fw-bold" id="modalMaestraLabel">
                    <i class="fas fa-user-graduate me-2"></i>Registrar Maestra
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="maestraForm" class="row g-3" novalidate>
                    <input type="hidden" id="IdMaestra" value="0" />

                    <div class="col-md-12">
                        <label class="form-label">Nombre completo</label>
                        <input type="text" id="Nombre" class="form-control" required />
                    </div>

                    <div class="col-md-12">
                        <label class="form-label">Institución</label>
                        <select id="IdInstitucion" class="form-select" required>
                            <option value="">Seleccione una institución</option>
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Sección</label>
                        <input type="text" id="Seccion" class="form-control" required />
                    </div>

                    <div class="col-md-6 d-flex align-items-center">
                        <label class="form-check-label me-2">Activo</label>
                        <input type="checkbox" id="Activo" class="form-check-input" checked />
                    </div>

                    <div class="col-12 text-end">
                        <button type="submit" class="btn pastel-btn me-2">Guardar</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function escapeHtml(s) {
            if (s === null || s === undefined) return '';
            return String(s)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#039;');
        }

        function ensureDt() {
            return window.jQuery && $.fn && $.fn.DataTable;
        }

        function initMaestrasDataTable() {
            if (!ensureDt()) return;

            if ($.fn.DataTable.isDataTable('#tablaMaestras')) {
                $('#tablaMaestras').DataTable().destroy();
            }

            $('#tablaMaestras').DataTable({
                pageLength: 10,
                lengthMenu: [5, 10, 25, 50, 100],
                ordering: true,
                searching: true,
                autoWidth: false,
                language: {
                    lengthMenu: "Mostrar _MENU_ registros",
                    zeroRecords: "No hay datos para mostrar",
                    info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
                    infoEmpty: "Mostrando 0 a 0 de 0 registros",
                    infoFiltered: "(filtrado de _MAX_ registros)",
                    search: "Buscar:",
                    paginate: {
                        first: "Primero",
                        last: "Último",
                        next: "Siguiente",
                        previous: "Anterior"
                    }
                }
            });
        }

        async function cargarInstituciones() {
            const r = await fetch('/GestionMaestras/InstitucionesLookup');
            if (!r.ok) throw new Error('No se pudieron cargar instituciones');
            const data = await r.json();

            const sel = document.getElementById('IdInstitucion');
            sel.innerHTML = '<option value="">Seleccione una institución</option>';

            data.forEach(x => {
                const o = document.createElement('option');
                o.value = x.idInstitucion;
                o.textContent = x.nombre;
                sel.appendChild(o);
            });
        }

        async function listarMaestras() {
            const r = await fetch('/GestionMaestras/Listar');
            if (!r.ok) throw new Error('No se pudieron cargar maestras');
            const data = await r.json();

            if (ensureDt() && $.fn.DataTable.isDataTable('#tablaMaestras')) {
                $('#tablaMaestras').DataTable().destroy();
            }

            const tbody = document.getElementById('tbodyMaestras');
            tbody.innerHTML = '';

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">No hay maestras registradas</td></tr>';
                initMaestrasDataTable();
                return;
            }

            data.forEach(m => {
                const tr = document.createElement('tr');

                const estado = m.activo === true
                    ? '<span class="badge badge-activo">Activo</span>'
                    : '<span class="badge badge-inactivo">Inactivo</span>';

                tr.innerHTML =
                    '<td>' + escapeHtml(m.nombre) + '</td>' +
                    '<td>' + escapeHtml(m.institucion) + '</td>' +
                    '<td>' + escapeHtml(m.seccion) + '</td>' +
                    '<td class="text-center">' + estado + '</td>' +
                    '<td class="text-center">' +
                        '<button type="button" class="btn btn-sm btn-outline-primary me-1" title="Editar" onclick="editarMaestra(' + m.idMaestra + ')">' +
                            '<i class="fas fa-edit"></i>' +
                        '</button>' +
                        '<button type="button" class="btn btn-sm btn-outline-danger" title="Eliminar" onclick="eliminarMaestra(' + m.idMaestra + ')">' +
                            '<i class="fas fa-trash"></i>' +
                        '</button>' +
                    '</td>';

                tbody.appendChild(tr);
            });

            initMaestrasDataTable();
        }

        function nuevaMaestra() {
            document.getElementById('IdMaestra').value = 0;
            document.getElementById('Nombre').value = '';
            document.getElementById('Seccion').value = '';
            document.getElementById('Activo').checked = true;
            document.getElementById('IdInstitucion').value = '';
            document.getElementById('modalMaestraLabel').innerHTML = '<i class="fas fa-user-graduate me-2"></i>Registrar Maestra';
        }

        async function editarMaestra(id) {
            const r = await fetch('/GestionMaestras/Obtener?id=' + id);
            if (!r.ok) throw new Error('No se pudo cargar la maestra');
            const m = await r.json();

            document.getElementById('IdMaestra').value = m.idMaestra;
            document.getElementById('Nombre').value = m.nombre || '';
            document.getElementById('Seccion').value = m.seccion || '';
            document.getElementById('Activo').checked = m.activo === true;
            document.getElementById('IdInstitucion').value = String(m.idInstitucion || '');
            document.getElementById('modalMaestraLabel').innerHTML = '<i class="fas fa-edit me-2"></i>Editar Maestra';

            new bootstrap.Modal(document.getElementById('modalMaestra')).show();
        }

        async function eliminarMaestra(id) {
            const ok = await Swal.fire({
                icon: 'warning',
                title: 'Confirmar eliminación',
                text: '¿Deseas eliminar esta maestra?',
                showCancelButton: true,
                confirmButtonText: 'Eliminar',
                cancelButtonText: 'Cancelar'
            });

            if (!ok.isConfirmed) return;

            const r = await fetch('/GestionMaestras/Eliminar?id=' + id, { method: 'DELETE' });
            if (!r.ok) {
                const t = await r.text();
                await Swal.fire({ icon: 'error', title: 'Error', text: t || 'No se pudo eliminar' });
                return;
            }

            await Swal.fire({ icon: 'success', title: 'Eliminado', text: 'La maestra fue eliminada correctamente.' });
            await listarMaestras();
        }

        document.getElementById('maestraForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const id = parseInt(document.getElementById('IdMaestra').value || '0', 10);
            const nombre = document.getElementById('Nombre').value || '';
            const seccion = document.getElementById('Seccion').value || '';
            const activo = document.getElementById('Activo').checked;
            const idInstitucionRaw = document.getElementById('IdInstitucion').value;

            if (!nombre.trim() || !seccion.trim() || !idInstitucionRaw) {
                await Swal.fire({ icon: 'warning', title: 'Validación', text: 'Complete todos los campos.' });
                return;
            }

            const esNuevo = id === 0;

            const confirm = await Swal.fire({
                icon: 'question',
                title: esNuevo ? 'Confirmar registro' : 'Confirmar actualización',
                text: esNuevo ? '¿Deseas agregar esta maestra?' : '¿Deseas guardar los cambios?',
                showCancelButton: true,
                confirmButtonText: esNuevo ? 'Agregar' : 'Guardar',
                cancelButtonText: 'Cancelar'
            });

            if (!confirm.isConfirmed) return;

            if (esNuevo) {
                const r = await fetch('/GestionMaestras/Crear', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nombre: nombre,
                        idInstitucion: parseInt(idInstitucionRaw, 10),
                        seccion: seccion
                    })
                });

                if (!r.ok) {
                    const t = await r.text();
                    await Swal.fire({ icon: 'error', title: 'Error', text: t || 'No se pudo crear' });
                    return;
                }

                await Swal.fire({ icon: 'success', title: 'Agregado', text: 'La maestra fue registrada correctamente.' });
            } else {
                const r = await fetch('/GestionMaestras/Actualizar?id=' + id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        idMaestra: id,
                        nombre: nombre,
                        idInstitucion: parseInt(idInstitucionRaw, 10),
                        seccion: seccion,
                        activo: activo
                    })
                });

                if (!r.ok) {
                    const t = await r.text();
                    await Swal.fire({ icon: 'error', title: 'Error', text: t || 'No se pudo actualizar' });
                    return;
                }

                await Swal.fire({ icon: 'success', title: 'Actualizado', text: 'Los cambios se guardaron correctamente.' });
            }

            const modalEl = document.getElementById('modalMaestra');
            const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            modal.hide();

            await listarMaestras();
        });

        document.addEventListener('DOMContentLoaded', async function () {
            try {
                await cargarInstituciones();
                await listarMaestras();
            } catch (e) {
                await Swal.fire({ icon: 'error', title: 'Error', text: e.message || 'Error al cargar datos' });
            }
        });
    </script>
}
