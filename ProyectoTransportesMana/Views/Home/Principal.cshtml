@{
    ViewData["Title"] = "Inicio";
    Layout = "_LayoutInterno";
}

@section Styles {
    <link rel="stylesheet" href="~/css/index/index.css" />

}

<div class="mb-4">
    <h1 class="text-dark fw-bold">Horarios de Salida 2026</h1>
</div>

<div id="contenedor-escuelas"></div>

@inject IConfiguration Configuration
<script>
    window.API_BASE = '@(Configuration["Api:BaseUrl"]?.TrimEnd('/') ?? "")';
 window.API_BASE = "https://localhost:7238";
</script>


<script>

        async function loadAllSimple() {
      try {
        const base = window.API_BASE || '';
        console.log('loadAllSimple usando base:', base);

        const res = await fetch(`${base}/api/v1/instituciones`);
        if (!res.ok) {
          console.error('Instituciones fetch error', res.status, await res.text());
          throw new Error('Error cargando instituciones. Status: ' + res.status);
        }
        const instituciones = await res.json();
        console.log('instituciones:', instituciones);

        const cont = document.getElementById('contenedor-escuelas');
        cont.innerHTML = '';


       for (const ins of instituciones) {

    // paleta pastel infinita
    const paletas = ['--pastel-purple', '--pastel-blue', '--pastel-pink', '--pastel-green'];

    // índice automático según ID
    const idx = Math.abs(ins.idInstitucion) % paletas.length;
    const varColor = paletas[idx];

    const card = document.createElement('div');
    card.className = 'card mb-4 shadow pastel-card';

    const headerStyle = `
      background: linear-gradient(90deg, var(${varColor}) 0%, rgba(255,255,255,0.85) 100%);
    `;

    card.innerHTML = `
      <div class="card-header pastel-header" style="${headerStyle}">
        ${escapeHtml(ins.nombre)}
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table id="tabla-inst-${ins.idInstitucion}" class="table pastel-table table-hover table-bordered mb-0">
            <thead class="table-light">
              <tr>
                <th>Sección</th><th>Estudiante</th>
                <th>Lunes</th><th>Martes</th><th>Miércoles</th>
                <th>Jueves</th><th>Viernes</th><th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    `;

    cont.appendChild(card);

          // trae estudiantes/horarios para esa institucion
          const stRes = await fetch(`${base}/api/v1/instituciones/${ins.idInstitucion}/estudiantes`);
          if (!stRes.ok) {
            console.warn(`No se pudieron cargar estudiantes de institucion ${ins.idInstitucion}. status=${stRes.status}`);
            continue;
          }
          const rows = await stRes.json();
          console.log(`rows institucion ${ins.idInstitucion}:`, rows);

          const alumnos = new Map();
          for (const r of rows) {
            const id = r.idEstudiante ?? r.id_estudiante ?? r.id;
            if (!alumnos.has(id)) {
              alumnos.set(id, {
                idEstudiante: id,
                seccion: r.seccion ?? '',
                nombreCompleto: r.nombreCompleto ?? r.nombre_completo ?? '',
                horarios: {}
              });
            }
            const a = alumnos.get(id);
            const dia = String(r.diaSemana ?? r.dia_semana ?? '').trim();
            if (dia) {
              a.horarios[dia] = {
                entrada: r.horaEntrada ?? r.hora_entrada ?? '',
                salida:  r.horaSalida  ?? r.hora_salida  ?? ''
              };
            }
          }

          const tbody = document.querySelector(`#tabla-inst-${ins.idInstitucion} tbody`);
          for (const alumno of alumnos.values()) {
            const tr = document.createElement('tr');
            tr.dataset.idEstudiante = alumno.idEstudiante;

            const dias = ['Lunes','Martes','Miércoles','Jueves','Viernes'];
            const tdDias = dias.map(d => {
              const h = alumno.horarios[d];
              const texto = h ? `${h.entrada ?? ''}${(h.entrada && h.salida) ? ' / ' : ''}${h.salida ?? ''}` : '';
              return `<td data-dia="${d}">${escapeHtml(texto)}</td>`;
            }).join('');

            tr.innerHTML =
              `<td>${escapeHtml(alumno.seccion)}</td>` +
              `<td>${escapeHtml(alumno.nombreCompleto)}</td>` +
              tdDias +
              `<td class="text-center">
                 <a href="#" onclick="editarHorarioSimple(this);return false;"><i class="fas fa-edit text-primary me-2"></i></a>
                 <a href="#" onclick="guardarHorarioSimple(this);return false;"><i class="fas fa-save" style="color:gold;"></i></a>
               </td>`;

            tbody.appendChild(tr);
          }
        }

      } catch (err) {
        console.error('loadAllSimple error:', err);
        alert('Error cargando datos. Revisa la consola.');
      }
    }

    /* editar/guardar simples */
    function editarHorarioSimple(aElem) {
      const tr = aElem.closest('tr');
      tr.querySelectorAll('td[data-dia]').forEach(td => {
        if (td.querySelector('input')) return;
        const text = td.textContent.trim();
        let entrada = '', salida = '';
        if (text.includes('/')) {
          const parts = text.split('/');
          entrada = parts[0].trim();
          salida  = parts[1].trim();
        } else {
          entrada = text;
        }
        td.innerHTML = `
          <input type="text" class="form-control form-control-sm hora-entrada" value="${escapeAttr(entrada)}" />
          <input type="text" class="form-control form-control-sm hora-salida mt-1" value="${escapeAttr(salida)}" />
        `;
      });
    }

      /** Validación simple de hora HH:mm (00:00 - 23:59) */
    function validarHoraSimple(h) {
        if (!h) return true; // permitir vacío (se interpreta como sin hora)
        // aceptar formatos con o sin cero delante: 9:05 o 09:05 -> pero aquí pedimos 2 dígitos para consistencia
        const re = /^([01]\d|2[0-3]):([0-5]\d)$/;
        return re.test(h);
    }

    /** Muestra texto para cada cambio y confirma con Swal antes de mandar */
    async function guardarHorarioSimple(aElem) {
        const tr = aElem.closest('tr');
        const idEstudiante = tr.dataset.idEstudiante;
        if (!idEstudiante) { Swal.fire('Error','Id de estudiante no encontrado','error'); return; }

        const base = window.API_BASE || '';

        // recopilar cambios
        const cambios = [];
        tr.querySelectorAll('td[data-dia]').forEach(td => {
            const inputE = td.querySelector('.hora-entrada');
            const inputS = td.querySelector('.hora-salida');
            if (!inputE && !inputS) return;

            const dia = td.dataset.dia;
            const entrada = inputE ? inputE.value.trim() : '';
            const salida  = inputS ? inputS.value.trim() : '';

            // si ambos vacíos => ignorar
            if (!entrada && !salida) return;

            // validar formato
            if (!validarHoraSimple(entrada) || !validarHoraSimple(salida)) {
                cambios.push({ dia, entrada, salida, valido: false });
            } else {
                cambios.push({ dia, entrada, salida, valido: true });
            }
        });

        if (cambios.length === 0) {
            Swal.fire('Nada que guardar','No se detectaron cambios en las celdas editables.','info');
            return;
        }

        // construir resumen para confirmar
        const resumenHtml = cambios.map(c => `<strong>${c.dia}</strong>: ${c.entrada || '-'} ${c.salida ? ' / ' + c.salida : ''}`).join('<br>');

        // mostrar confirmación similar a eliminarEstudiante
        const res = await Swal.fire({
            title: 'Guardar horarios',
            html: `Se guardarán los siguientes horarios para el estudiante:<br><br>${resumenHtml}`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Sí, guardar',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#aaa'
        });

        if (!res.isConfirmed) return;

        // enviar todas las peticiones (paralelas)
        try {
            const promises = cambios.map(c => {
                const body = {
                    idEstudiante: parseInt(idEstudiante, 10),
                    diaSemana: c.dia,
                    horaEntrada: c.entrada,
                    horaSalida: c.salida
                };
                // fetch PUT al endpoint
                return fetch(`${base}/api/v1/horarios`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                }).then(async r => {
                    if (r.ok) return r;
                    // si devuelve 204 No Content (algunas APIs usan esto), r.ok también es true para 204
                    // manejar / lanzar error con mensaje cuando no sea ok
                    let texto = '';
                    try { texto = await r.text(); } catch {}
                    throw new Error(`Error ${r.status} al guardar ${c.dia}: ${texto || r.statusText}`);
                });
            });

            // mostrar cargando
            Swal.fire({ title: 'Guardando...', didOpen: () => Swal.showLoading(), allowOutsideClick: false, allowEscapeKey: false });

            await Promise.all(promises);

            Swal.fire({ icon: 'success', title: 'Horarios guardados', timer: 1400, showConfirmButton: false });

            // actualizar la UI: reemplazar inputs por texto
            tr.querySelectorAll('td[data-dia]').forEach(td => {
                const inputE = td.querySelector('.hora-entrada');
                const inputS = td.querySelector('.hora-salida');
                if (!inputE && !inputS) return;
                const e = inputE ? inputE.value.trim() : '';
                const s = inputS ? inputS.value.trim() : '';
                td.textContent = e && s ? `${e} / ${s}` : (e || s || '');
            });

        } catch (err) {
            console.error('guardarHorarioSimple error:', err);
            Swal.fire('Error','Ocurrió un error guardando los horarios. Revisa la consola para más detalles.','error');
        }
    }

    function escapeHtml(s) { if (s == null) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
    function escapeAttr(s) { if (s == null) return ''; return String(s).replaceAll('"','&quot;').replaceAll("'", '&#039;'); }

    document.addEventListener('DOMContentLoaded', loadAllSimple);
</script>