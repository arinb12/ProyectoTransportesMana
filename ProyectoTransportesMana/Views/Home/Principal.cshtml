@{
    ViewData["Title"] = "Inicio";
    Layout = "_LayoutInterno";
}

<div class="mb-4">
    <h1 class="text-dark fw-bold">Horarios de Salida 2026</h1>
</div>

<div id="contenedor-escuelas"></div>

@inject IConfiguration Configuration
<script>
    window.API_BASE = '@(Configuration["Api:BaseUrl"]?.TrimEnd('/') ?? "")';
    // ejemplo: window.API_BASE = "https://localhost:7238";
</script>


<script>

        async function loadAllSimple() {
      try {
        const base = window.API_BASE || '';
        console.log('loadAllSimple usando base:', base);

        const res = await fetch(`${base}/api/v1/instituciones`);
        if (!res.ok) {
          console.error('Instituciones fetch error', res.status, await res.text());
          throw new Error('Error cargando instituciones. Status: ' + res.status);
        }
        const instituciones = await res.json();
        console.log('instituciones:', instituciones);

        const cont = document.getElementById('contenedor-escuelas');
        cont.innerHTML = '';

        for (const ins of instituciones) {
          const card = document.createElement('div');
          card.className = 'card mb-4 shadow';
          card.innerHTML = `
            <div class="card-header bg-pastel text-dark fw-bold">${escapeHtml(ins.nombre)}</div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table id="tabla-inst-${ins.idInstitucion}" class="table pastel-table table-hover table-bordered mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>Sección</th><th>Estudiante</th>
                      <th>Lunes</th><th>Martes</th><th>Miércoles</th>
                      <th>Jueves</th><th>Viernes</th><th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>`;
          cont.appendChild(card);

          // trae estudiantes/horarios para esa institucion
          const stRes = await fetch(`${base}/api/v1/instituciones/${ins.idInstitucion}/estudiantes`);
          if (!stRes.ok) {
            console.warn(`No se pudieron cargar estudiantes de institucion ${ins.idInstitucion}. status=${stRes.status}`);
            continue;
          }
          const rows = await stRes.json();
          console.log(`rows institucion ${ins.idInstitucion}:`, rows);

          const alumnos = new Map();
          for (const r of rows) {
            const id = r.idEstudiante ?? r.id_estudiante ?? r.id;
            if (!alumnos.has(id)) {
              alumnos.set(id, {
                idEstudiante: id,
                seccion: r.seccion ?? '',
                nombreCompleto: r.nombreCompleto ?? r.nombre_completo ?? '',
                horarios: {}
              });
            }
            const a = alumnos.get(id);
            const dia = String(r.diaSemana ?? r.dia_semana ?? '').trim();
            if (dia) {
              a.horarios[dia] = {
                entrada: r.horaEntrada ?? r.hora_entrada ?? '',
                salida:  r.horaSalida  ?? r.hora_salida  ?? ''
              };
            }
          }

          const tbody = document.querySelector(`#tabla-inst-${ins.idInstitucion} tbody`);
          for (const alumno of alumnos.values()) {
            const tr = document.createElement('tr');
            tr.dataset.idEstudiante = alumno.idEstudiante;

            const dias = ['Lunes','Martes','Miércoles','Jueves','Viernes'];
            const tdDias = dias.map(d => {
              const h = alumno.horarios[d];
              const texto = h ? `${h.entrada ?? ''}${(h.entrada && h.salida) ? ' / ' : ''}${h.salida ?? ''}` : '';
              return `<td data-dia="${d}">${escapeHtml(texto)}</td>`;
            }).join('');

            tr.innerHTML =
              `<td>${escapeHtml(alumno.seccion)}</td>` +
              `<td>${escapeHtml(alumno.nombreCompleto)}</td>` +
              tdDias +
              `<td class="text-center">
                 <a href="#" onclick="editarHorarioSimple(this);return false;"><i class="fas fa-edit text-primary me-2"></i></a>
                 <a href="#" onclick="guardarHorarioSimple(this);return false;"><i class="fas fa-save" style="color:gold;"></i></a>
               </td>`;

            tbody.appendChild(tr);
          }
        }

      } catch (err) {
        console.error('loadAllSimple error:', err);
        alert('Error cargando datos. Revisa la consola.');
      }
    }

    /* editar/guardar simples */
    function editarHorarioSimple(aElem) {
      const tr = aElem.closest('tr');
      tr.querySelectorAll('td[data-dia]').forEach(td => {
        if (td.querySelector('input')) return;
        const text = td.textContent.trim();
        let entrada = '', salida = '';
        if (text.includes('/')) {
          const parts = text.split('/');
          entrada = parts[0].trim();
          salida  = parts[1].trim();
        } else {
          entrada = text;
        }
        td.innerHTML = `
          <input type="text" class="form-control form-control-sm hora-entrada" value="${escapeAttr(entrada)}" />
          <input type="text" class="form-control form-control-sm hora-salida mt-1" value="${escapeAttr(salida)}" />
        `;
      });
    }

    async function guardarHorarioSimple(aElem) {
      const tr = aElem.closest('tr');
      const idEstudiante = tr.dataset.idEstudiante;
      if (!idEstudiante) { alert('Id de estudiante no encontrado'); return; }

      const base = window.API_BASE || '';

      const promises = [];
      tr.querySelectorAll('td[data-dia]').forEach(td => {
        const inputE = td.querySelector('.hora-entrada');
        const inputS = td.querySelector('.hora-salida');
        if (!inputE && !inputS) return;
        const dia = td.dataset.dia;
        const entrada = inputE ? inputE.value.trim() : '';
        const salida  = inputS ? inputS.value.trim() : '';
        if (!entrada && !salida) return;

        const body = {
          idEstudiante: parseInt(idEstudiante, 10),
          diaSemana: dia,
          horaEntrada: entrada,
          horaSalida: salida
        };

        promises.push(
          fetch(`${base}/api/v1/horarios`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          }).then(r => {
            if (!r.ok) throw new Error(`Error actualizando ${dia} (status ${r.status})`);
          })
        );
      });

      if (promises.length === 0) { alert('No hay cambios para guardar'); return; }

      try {
        await Promise.all(promises);
        tr.querySelectorAll('td[data-dia]').forEach(td => {
          const inputE = td.querySelector('.hora-entrada');
          const inputS = td.querySelector('.hora-salida');
          if (!inputE && !inputS) return;
          const e = inputE ? inputE.value.trim() : '';
          const s = inputS ? inputS.value.trim() : '';
          td.textContent = e && s ? `${e} / ${s}` : (e || s || '');
        });
        alert('Horarios guardados');
      } catch (err) {
        console.error('guardarHorarioSimple error:', err);
        alert('Error guardando horarios. Revisa la consola.');
      }
    }

    function escapeHtml(s) { if (s == null) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
    function escapeAttr(s) { if (s == null) return ''; return String(s).replaceAll('"','&quot;').replaceAll("'", '&#039;'); }

    document.addEventListener('DOMContentLoaded', loadAllSimple);
</script>