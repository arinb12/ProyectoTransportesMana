@model IEnumerable<ProyectoTransportesMana.Contracts.Estudiantes.EstudianteListItemResponse>

@{
    ViewData["Title"] = "Mis hijos";
    Layout = "~/Views/Shared/_LayoutInterno.cshtml";
}

<div class="container-fluid p-4">
    <h2 class="text-dark mb-3">Estudiantes registrados</h2>

    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
        @if (Model != null && Model.Any())
        {
            foreach (var est in Model)
            {
                <div class="col">
                    <div class="card h-100 shadow pastel-card">
                        <div class="card-body">
                            <h5 class="fw-bold">@est.NombreCompletoEstudiante</h5>
                            <p><strong>Encargado:</strong> @est.Encargado</p>
                            <p><strong>Institución:</strong> @est.Institucion</p>
                            <p><strong>Sección:</strong> @est.Seccion</p>
                            <p><strong>Maestra:</strong> @est.Maestra</p>
                            <p><strong>Teléfono:</strong> @est.Telefono</p>

                            <button type="button"
                                    class="btn btn-primary mt-2 btn-editar-horario"
                                    data-id-estudiante="@est.Id"
                                    data-nombre-estudiante="@est.NombreCompletoEstudiante">
                                Configurar horario anual
                            </button>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="col-12">
                <div class="alert alert-info">
                    No hay estudiantes vinculados a este encargado legal.
                </div>
            </div>
        }
    </div>
</div>

<div class="modal fade" id="modalHorario" tabindex="-1" aria-labelledby="modalHorarioLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalHorarioLabel">Horario anual</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body" id="modalHorarioBody">
                Cargando...
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var modalElement = document.getElementById('modalHorario');
            var modal = new bootstrap.Modal(modalElement);
            var modalBody = document.getElementById('modalHorarioBody');
            var modalTitle = document.getElementById('modalHorarioLabel');

            document.querySelectorAll('.btn-editar-horario').forEach(function (btn) {
                btn.addEventListener('click', function () {
                    var idEstudiante = this.getAttribute('data-id-estudiante');
                    var nombre = this.getAttribute('data-nombre-estudiante');
                    modalTitle.textContent = 'Horario anual de ' + nombre;
                    modalBody.innerHTML = 'Cargando...';

                    fetch('/PortalPadres/EditarHorario?idEstudiante=' + idEstudiante)
                        .then(function (r) {
                            if (!r.ok) throw new Error('Error al cargar el horario');
                            return r.text();
                        })
                        .then(function (html) {
                            modalBody.innerHTML = html;

                            var form = modalBody.querySelector('form');
                            if (form) {
                                form.addEventListener('submit', function (e) {
                                    e.preventDefault();

                                    var formData = new FormData(form);

                                    fetch(form.action, {
                                        method: 'POST',
                                        body: formData
                                    })
                                        .then(function (r) {
                                            if (!r.ok) throw new Error('Error al guardar el horario');
                                            return r.json();
                                        })
                                        .then(function (data) {
                                            if (data && data.ok) {
                                                modal.hide();
                                                location.reload();
                                            }
                                        })
                                        .catch(function (err) {
                                            alert(err.message);
                                        });
                                });
                            }

                            modal.show();
                        })
                        .catch(function (err) {
                            modalBody.innerHTML = '<p>' + err.message + '</p>';
                            modal.show();
                        });
                });
            });
        });
    </script>
}
